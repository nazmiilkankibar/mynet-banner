<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mynet Banner</title>
  <style>
  :root{
    --bg:#0f172a;
    --card:#111827;
    --muted:rgba(255,255,255,.75);
  }
  body { margin:0; font-family: Arial, sans-serif; background:var(--bg); color:#fff; }
  header{ padding:16px 16px 6px; }
  h2 { margin:0; font-size:28px; }
  #status { margin-top:6px; opacity:.85; font-size:13px; color:var(--muted); }

  .wrap{ padding: 10px 16px 22px; }
  .grid{
    display:grid;
    grid-template-columns: 1.6fr 1fr;
    gap:14px;
    align-items:stretch;
  }

  a{ color:inherit; text-decoration:none; }

  .hero{
    background:var(--card);
    border-radius:16px;
    overflow:hidden;
    position:relative;
    min-height:360px;
    box-shadow:0 10px 24px rgba(0,0,0,.45);
  }
  .hero img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    filter:saturate(1.05);
  }
  .hero .overlay{
    position:absolute;
    left:0; right:0; bottom:0;
    padding:18px;
    background: linear-gradient(transparent, rgba(0,0,0,.75));
  }
  .hero .title{
    font-size:22px;
    font-weight:700;
    line-height:1.25;
    text-shadow: 0 2px 10px rgba(0,0,0,.6);
  }

  .side{
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .mini{
    display:flex;
    gap:12px;
    background:var(--card);
    border-radius:14px;
    overflow:hidden;
    min-height:110px;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  .mini img{
    width:140px;
    height:110px;
    object-fit:cover;
    flex:0 0 140px;
    display:block;
  }
  .mini .txt{
    padding:12px 12px 12px 0;
    display:flex;
    align-items:center;
  }
  .mini .txt div{
    font-size:14px;
    font-weight:700;
    line-height:1.35;
  }

  .hint{
    color:var(--muted);
    font-size:12px;
    margin-top:10px;
  }

  @media (max-width: 900px){
    .grid{ grid-template-columns: 1fr; }
    .hero{ min-height:280px; }
    .mini img{ width:120px; flex-basis:120px; }
  }
</style>

</head>
<body>
  <header>
    <h2>Gunun One Cikan Haberleri</h2>
    <div id="status">Yukleniyor...</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <a id="heroLink" class="hero" href="#" target="_blank" rel="noopener">
        <img id="heroImg" src="" alt="">
        <div class="overlay">
          <div id="heroTitle" class="title"></div>
        </div>
      </a>

      <div id="side" class="side"></div>
    </div>

    <div class="hint">Her 4 saniyede bir ana haber degisir.</div>
  </div>

<script>
  const API_URL = 'https://nilknkbr.app.n8n.cloud/webhook/banner-news';
  const statusEl = document.getElementById('status');

  let newsData = [];
  let rotIndex = 0;
  let rotTimer = null;

  function setStatus(t) { statusEl.textContent = t; }

  function normalizeList(json) {
    if (Array.isArray(json)) return json;
    if (Array.isArray(json?.data)) return json.data;
    if (Array.isArray(json?.news)) return json.news;
    return [];
  }

  function render() {
    if (!newsData.length) return;

    const hero = newsData[rotIndex % newsData.length];
    const heroLink = document.getElementById('heroLink');
    const heroImg = document.getElementById('heroImg');
    const heroTitle = document.getElementById('heroTitle');

    heroLink.href = hero.url;
    heroImg.src = hero.imageUrl || '';
    heroTitle.textContent = hero.title || '';

    const side = document.getElementById('side');
    side.innerHTML = '';

    const others = newsData
      .filter((_, i) => i !== (rotIndex % newsData.length))
      .slice(0, 3);

    for (const item of others) {
      const a = document.createElement('a');
      a.className = 'mini';
      a.href = item.url;
      a.target = '_blank';
      a.rel = 'noopener';
      a.innerHTML = `
        <img src="${item.imageUrl || ''}" alt="">
        <div class="txt"><div>${item.title || ''}</div></div>
      `;
      side.appendChild(a);
    }

    setStatus('Toplam: ' + newsData.length);
  }

  function startRotation(){
    if (rotTimer) clearInterval(rotTimer);
    rotTimer = setInterval(() => {
      if (!newsData.length) return;
      rotIndex = (rotIndex + 1) % newsData.length;
      render();
    }, 4000);
  }

  async function fetchNews() {
    try {
      setStatus('Veri aliniyor...');
      const res = await fetch(API_URL, { cache: 'no-store' });

      if (res.status === 304) {
        setStatus('Degisiklik yok (304).');
        return;
      }

      const json = await res.json();
      const list = normalizeList(json)
        .filter(x => x && x.title && x.url && !String(x.url).includes('bit.ly'));

      if (list.length === 0) {
        setStatus('Liste bos geldi. (JSON formatini kontrol et)');
        return;
      }

      // Title bazli dedupe
      const existing = new Set(newsData.map(n => n.title));
      const fresh = list.filter(n => !existing.has(n.title));

      if (newsData.length === 0) {
        newsData = list;
        rotIndex = 0;
        render();
      } else if (fresh.length > 0) {
        newsData = [...newsData, ...fresh];
        render();
      } else {
        setStatus('Degisiklik yok. Toplam: ' + newsData.length);
      }

    } catch (e) {
      console.error(e);
      setStatus('Hata: API alinamadi (Consoleâ€™a bak).');
    }
  }

  (async () => {
    await fetchNews();
    startRotation();
    setInterval(fetchNews, 5 * 60 * 1000);
  })();
</script>

</body>
</html>
